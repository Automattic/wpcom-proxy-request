{"version":3,"sources":["../index.js"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["\n/**\n * Module dependencies.\n */\nimport uid from 'uid';\nimport WPError from 'wp-error';\nimport event from 'component-event';\nimport ProgressEvent from 'progress-event';\nimport debugFactory from 'debug';\n\n/**\n * debug instance\n */\nconst debug = debugFactory( 'wpcom-proxy-request' );\n\n/**\n * WordPress.com REST API base endpoint.\n */\nconst proxyOrigin = 'https://public-api.wordpress.com';\n\n/**\n * \"Origin\" of the current HTML page.\n */\nconst origin = window.location.protocol + '//' + window.location.host;\n\n/**\n * Detecting support for the structured clone algorithm. IE8 and 9, and Firefox\n * 6.0 and below only support strings as postMessage's message. This browsers\n * will try to use the toString method.\n *\n * https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage\n * https://developer.mozilla.org/en-US/docs/Web/Guide/API/DOM/The_structured_clone_algorithm\n * https://github.com/Modernizr/Modernizr/issues/388#issuecomment-31127462\n */\nconst postStrings = ( () => {\n\tlet r = false;\n\ttry {\n\t\twindow.postMessage( {\n\t\t\ttoString: function() {\n\t\t\t\tr = true;\n\t\t\t}\n\t\t}, '*' );\n\t} catch ( e ) { /* empty */ }\n\treturn r;\n} )();\n\n/**\n * Reference to the <iframe> DOM element.\n * Gets set in the install() function.\n */\nlet iframe = null;\n\n/**\n * Set to `true` upon the iframe's \"load\" event.\n */\nlet loaded = false;\n\n/**\n * Array of buffered API requests. Added to when API requests are done before the\n * proxy <iframe> is \"loaded\", and fulfilled once the \"load\" DOM event on the\n * iframe occurs.\n */\nlet buffered;\n\n/**\n * Firefox apparently doesn't like sending `File` instances cross-domain.\n * It results in a \"DataCloneError: The object could not be cloned.\" error.\n * Apparently this is for \"security purposes\" but it's actually silly if that's\n * the argument because we can just read the File manually into an ArrayBuffer\n * and we can work around this \"security restriction\".\n *\n * See: https://bugzilla.mozilla.org/show_bug.cgi?id=722126#c8\n */\nlet hasFileSerializationBug = false;\n\n/**\n * In-flight API request XMLHttpRequest dummy \"proxy\" instances.\n */\nconst requests = {};\n\n/**\n * Are HTML5 XMLHttpRequest2 \"progress\" events supported?\n * See: http://goo.gl/xxYf6D\n */\nconst supportsProgress = !! window.ProgressEvent && !! window.FormData;\n\ndebug( 'using \"origin\": %o', origin );\n\n/**\n * Performs a \"proxied REST API request\". This happens by calling\n * `iframe.postMessage()` on the proxy iframe instance, which from there\n * takes care of WordPress.com user authentication (via the currently\n * logged-in user's cookies).\n *\n * @param {Object|String} originalParams - request parameters\n * @param {Function} [fn] - callback response\n * @return {XMLHttpRequest} XMLHttpRequest instance\n * @api public\n */\nconst request = ( originalParams, fn ) => {\n\tlet params = Object.assign( {}, originalParams );\n\n\tdebug( 'request(%o)', params );\n\n\t// inject the <iframe> upon the first proxied API request\n\tif ( ! iframe ) {\n\t\tinstall();\n\t}\n\n\tif ( 'string' === typeof params ) {\n\t\tparams = { path: params };\n\t}\n\n\t// generate a uid for this API request\n\tconst id = uid();\n\tparams.callback = id;\n\tparams.supports_args = true; // supports receiving variable amount of arguments\n\tparams.supports_error_obj = true; // better Error object info\n\tparams.supports_progress = supportsProgress; // supports receiving XHR \"progress\" events\n\n\t// force uppercase \"method\" since that's what the <iframe> is expecting\n\tparams.method = String( params.method || 'GET' ).toUpperCase();\n\n\tdebug( 'params object: %o', params );\n\n\tconst xhr = new XMLHttpRequest();\n\txhr.params = params;\n\n\t// store the `XMLHttpRequest` instance so that \"onmessage\" can access it again\n\trequests[ id ] = xhr;\n\n\tif ( 'function' === typeof fn ) {\n\t\t// a callback function was provided\n\t\tlet called = false;\n\t\tfunction xhrOnLoad( e ) {\n\t\t\tif ( called ) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tcalled = true;\n\t\t\tconst body = e.response || xhr.response;\n\t\t\tdebug( 'body: ', body );\n\t\t\tdebug( 'headers: ', e.headers );\n\t\t\tfn( null, body, e.headers );\n\t\t}\n\t\tfunction xhrOnError( e ) {\n\t\t\tif ( called ) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tcalled = true;\n\t\t\tconst error = e.error || e.err || e;\n\t\t\tdebug( 'error: ', error );\n\t\t\tdebug( 'headers: ', e.headers );\n\t\t\tfn( error, null, e.headers );\n\t\t}\n\n\t\tevent.bind( xhr, 'load', xhrOnLoad );\n\t\tevent.bind( xhr, 'abort', xhrOnError );\n\t\tevent.bind( xhr, 'error', xhrOnError );\n\t}\n\n\tif ( loaded ) {\n\t\tsubmitRequest( params );\n\t} else {\n\t\tdebug( 'buffering API request since proxying <iframe> is not yet loaded' );\n\t\tbuffered.push( params );\n\t}\n\n\treturn xhr;\n};\n\n/**\n * Calls the `postMessage()` function on the <iframe>.\n *\n * @param {Object} params\n * @api private\n */\n\nfunction submitRequest( params ) {\n\tdebug( 'sending API request to proxy <iframe> %o', params );\n\n\tif ( hasFileSerializationBug && hasFile( params ) ) {\n\t\tpostAsArrayBuffer( params );\n\t} else {\n\t\ttry {\n\t\t\tiframe.contentWindow.postMessage( postStrings ? JSON.stringify( params ) : params, proxyOrigin );\n\t\t} catch ( e ) {\n\t\t\t// were we trying to serialize a `File`?\n\t\t\tif ( hasFile( params ) ) {\n\t\t\t\tdebug( 'this browser has the File serialization bug' );\n\t\t\t\t// cache this check for the next API request\n\t\t\t\thasFileSerializationBug = true;\n\t\t\t\tpostAsArrayBuffer( params );\n\t\t\t} else {\n\t\t\t\t// not interested, rethrow\n\t\t\t\tthrow e;\n\t\t\t}\n\t\t}\n\t}\n}\n\n/**\n * Returns `true` if there's a `File` instance in the `params`, or `false`\n * otherwise.\n *\n * @param {Object} params - request parameter\n * @return {Boolean} `true` if there's a `File`\n * @private\n */\nfunction hasFile( params ) {\n\tconst formData = params.formData;\n\tif ( formData && formData.length > 0 ) {\n\t\tfor ( let i = 0; i < formData.length; i++ ) {\n\t\t\tif ( isFile( formData[ i ][ 1 ] ) ) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t}\n\treturn false;\n}\n\n/**\n * Returns `true` if `v` is a DOM File instance, `false` otherwise.\n *\n * @param {Mixed} v - instance to analize\n * @return {Boolean} `true` if `v` is a DOM File instance\n * @private\n */\nfunction isFile( v ) {\n\treturn v && Object.prototype.toString.call( v ) === '[object File]';\n}\n\n/**\n * Turns all `File` instances into `ArrayBuffer` objects in order to serialize\n * the data over the iframe `postMessage()` call.\n *\n * @param {Object} params\n * @private\n */\n\nfunction postAsArrayBuffer( params ) {\n\tdebug( 'converting File instances to ArrayBuffer before invoking postMessage()' );\n\n\tconst formData = params.formData;\n\tlet count = 0;\n\tlet called = false;\n\tfor ( let i = 0; i < formData.length; i++ ) {\n\t\tconst val = formData[ i ][ 1 ];\n\t\tif ( isFile( val ) ) {\n\t\t\tcount++;\n\t\t\tfileToArrayBuffer( val, i, onLoadFile );\n\t\t}\n\t}\n\n\tif ( 0 === count ) {\n\t\tpostMessage();\n\t}\n\n\tfunction onLoadFile( err, file, j ) {\n\t\tif ( called ) {\n\t\t\treturn;\n\t\t}\n\n\t\tif ( err ) {\n\t\t\tcalled = true;\n\t\t\treject( err );\n\t\t\treturn;\n\t\t}\n\n\t\tformData[ j ][ 1 ] = file;\n\n\t\tcount--;\n\t\tif ( 0 === count ) {\n\t\t\tpostMessage();\n\t\t}\n\t}\n\n\tfunction postMessage() {\n\t\tdebug( 'finished reading all Files' );\n\t\tiframe.contentWindow.postMessage( params, proxyOrigin );\n\t}\n}\n\n/**\n * Turns a `File` instance into a regular JavaScript object with `fileContents`\n * as an ArrayBuffer, and `fileName` and `mimeTypes`.\n *\n * @param {File} file\n * @param {Number} index\n * @param {Function} fn\n * @private\n */\n\nfunction fileToArrayBuffer( file, index, fn ) {\n\tconst reader = new FileReader();\n\n\treader.onload = function( e ) {\n\t\tconst arrayBuffer = e.target.result;\n\t\tdebug( 'finished reading file %o (%o bytes)', file.name, arrayBuffer.byteLength );\n\n\t\tfn( null, {\n\t\t\tfileContents: arrayBuffer,\n\t\t\tfileName: file.name,\n\t\t\tmimeType: file.type\n\t\t}, index );\n\t};\n\n\treader.onerror = function( err ) {\n\t\tdebug( 'got error reading file %o (%o bytes)', file.name, err );\n\t\tfn( err );\n\t};\n\n\treader.readAsArrayBuffer( file );\n}\n\n/**\n * Injects the proxy <iframe> instance in the <body> of the current\n * HTML page.\n *\n * @api private\n */\n\nfunction install() {\n\tdebug( 'install()' );\n\tif ( iframe ) {\n\t\tuninstall();\n\t}\n\n\tbuffered = [];\n\n\t// listen to messages sent to `window`\n\tevent.bind( window, 'message', onmessage );\n\n\t// create the <iframe>\n\tiframe = document.createElement( 'iframe' );\n\n\t// set `src` and hide the iframe\n\tiframe.src = proxyOrigin + '/wp-admin/rest-proxy/#' + origin;\n\tiframe.style.display = 'none';\n\n\t// inject the <iframe> into the <body>\n\tdocument.body.appendChild( iframe );\n}\n\n/**\n * Reloads the proxy iframe.\n *\n * @api public\n */\nconst reloadProxy = () => {\n\tinstall();\n};\n\n/**\n * Removes the <iframe> proxy instance from the <body> of the page.\n *\n * @api private\n */\nfunction uninstall() {\n\tdebug( 'uninstall()' );\n\tdocument.body.removeChild( iframe );\n\tloaded = false;\n\tiframe = null;\n}\n\n/**\n * The proxy <iframe> instance's \"load\" event callback function.\n *\n * @api private\n */\n\nfunction onload() {\n\tdebug( 'proxy <iframe> \"load\" event' );\n\tloaded = true;\n\n\t// flush any buffered API calls\n\tif ( buffered ) {\n\t\tfor ( let i = 0; i < buffered.length; i++ ) {\n\t\t\tsubmitRequest( buffered[ i ] );\n\t\t}\n\t\tbuffered = null;\n\t}\n}\n\n/**\n * The main `window` object's \"message\" event callback function.\n *\n * @param {Event} e\n * @api private\n */\n\nfunction onmessage( e ) {\n\tdebug( 'onmessage' );\n\n\t// safeguard...\n\tif ( e.origin !== proxyOrigin ) {\n\t\tdebug( 'ignoring message... %o !== %o', e.origin, proxyOrigin );\n\t\treturn;\n\t}\n\n\tlet { data } = e;\n\tif ( ! data ) {\n\t\treturn debug( 'no `data`, bailing' );\n\t}\n\n\t// Once the iframe is loaded, we can start using it.\n\tif (data === '[\"ready\",200,null]') {\n\t\tonload();\n\t\treturn;\n\t}\n\n\tif ( postStrings && 'string' === typeof data ) {\n\t\tdata = JSON.parse( data );\n\t}\n\n\t// check if we're receiving a \"progress\" event\n\tif ( data.upload || data.download ) {\n\t\treturn onprogress( data );\n\t}\n\n\tif ( ! data.length ) {\n\t\treturn debug( '`e.data` doesn\\'t appear to be an Array, bailing...' );\n\t}\n\n\t// first get the `xhr` instance that we're interested in\n\tconst id = data[ data.length - 1 ];\n\tif ( ! ( id in requests ) ) {\n\t\treturn debug( 'bailing, no matching request with callback: %o', id );\n\t}\n\n\tconst xhr = requests[ id ];\n\n\t// Build `error` and `body` object from the `data` object\n\tconst { params } = xhr;\n\tlet body, statusCode, headers;\n\n\t// apiNamespace (WP-API)\n\tconst { apiNamespace } = params;\n\n\t// is REST-API api?\n\tconst isRestAPI = apiNamespace === undefined;\n\n\tif ( isRestAPI ) {\n\t\tdebug( 'REST-API detected' );\n\t\tbody = data[ 0 ];\n\t\tstatusCode = data[ 1 ];\n\t\theaders = data[ 2 ];\n\t} else {\n\t\tdebug( 'WP-API detected' );\n\t\tbody = data[ 0 ];\n\t\theaders = data[ 2 ];\n\n\t\t// Identify error response in `envelope` mode in function of the response fields\n\t\t// and try to make the same error structure for both APIs\n\t\tif (\n\t\t\tbody.code &&\n\t\t\t( body.data && body.data.status ) &&\n\t\t\tbody.message\n\t\t) {\n\t\t\tbody.error = body.code;\n\t\t\tstatusCode = body.data.status;\n\t\t\tdelete body.code;\n\t\t\tdelete body.data;\n\t\t}\n\t}\n\n\tif ( statusCode === 207 ) {\n\t\t// 207 is a signal from rest-proxy. It means, \"this isn't the final\n\t\t// response to the query.\" The proxy supports WebSocket connections\n\t\t// by invoking the original success callback for each message received.\n\t} else {\n\t\t// this is the final response to this query\n\t\tdelete requests[ id ];\n\t}\n\n\tif ( ! params.metaAPI ) {\n\t\tdebug( 'got %o status code for URL: %o', statusCode, params.path );\n\t} else {\n\t\tstatusCode = body === 'metaAPIupdated' ? 200 : 500;\n\t}\n\n\t// add statusCode into headers object\n\tif ( typeof headers === 'object' ) {\n\t\theaders.status = statusCode;\n\t}\n\n\tif ( null === statusCode || 2 === Math.floor( statusCode / 100 ) ) {\n\t\t// 2xx status code, success\n\t\tresolve( xhr, body, headers );\n\t} else {\n\t\t// any other status code is a failure\n\t\tconst wpe = WPError( params, statusCode, body );\n\t\treject( xhr, wpe, headers );\n\t}\n}\n\n/**\n * Handles a \"progress\" event being proxied back from the iframe page.\n *\n * @param {Object} data\n * @private\n */\n\nfunction onprogress( data ) {\n\tdebug( 'got \"progress\" event: %o', data );\n\tconst xhr = requests[ data.callbackId ];\n\tif ( xhr ) {\n\t\tconst prog = new ProgressEvent( 'progress', data );\n\t\tconst target = data.upload ? xhr.upload : xhr;\n\t\ttarget.dispatchEvent( prog );\n\t}\n}\n\n/**\n * Emits the \"load\" event on the `xhr`.\n *\n * @param {XMLHttpRequest} xhr\n * @param {Object} body\n * @private\n */\n\nfunction resolve( xhr, body, headers ) {\n\tconst e = new ProgressEvent( 'load' );\n\te.data = e.body = e.response = body;\n\te.headers = headers;\n\txhr.dispatchEvent( e );\n}\n\n/**\n * Emits the \"error\" event on the `xhr`.\n *\n * @param {XMLHttpRequest} xhr\n * @param {Error} err\n * @private\n */\n\nfunction reject( xhr, err, headers ) {\n\tconst e = new ProgressEvent( 'error' );\n\te.error = e.err = err;\n\te.headers = headers;\n\txhr.dispatchEvent( e );\n}\n\n/**\n * Export `request` function.\n */\nexport default request;\nexport { reloadProxy };\n"]}